<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Todo Dashboard</title>
    <link rel="stylesheet" href="styles/dashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
<div class="header-outer">
    <div class="logo">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6d/Todoist_logo.png" alt="Todoist Logo">
    </div>
    <div class="signup">
        <button id="btnLogout" class="btn btn-outline-primary btn-sm">Logout</button>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Add new Todo
                    </h5>
                </div>
                <div class="card-body">
                    <form id="todoForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="todoTitle" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="todoTitle" required/>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="todoDescription" class="form-label">Description *</label>
                                <input type="text" class="form-control" id="todoDescription" required/>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="todoDueDate" class="form-label">Due Date *</label>
                                <input type="datetime-local" class="form-control" id="todoDueDate" required/>
                            </div>
                            <div class="col-12">
                                <button class="btn col-12 btn-primary" type="submit">Add Todo</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-12 mt-4">
            <ul class="nav nav-tabs mb-4" id="todoTabs">
                <li class="nav-item">
                    <button type="button" class="nav-link active" id="all-tab" data-bs-toggle="tab"
                            data-bs-target="#all">
                        All Todos
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" id="pending-tab" data-bs-toggle="tab"
                            data-bs-target="#pending">
                        Pending
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" id="completed-tab" data-bs-toggle="tab"
                            data-bs-target="#completed">
                        Completed
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="todoTabContent">
                <div class="tab-pane fade show active" id="all">
                    <div id="allTodos"></div>
                </div>
                <div class="tab-pane fade" id="pending">
                    <div id="pendingTodos"></div>
                </div>
                <div class="tab-pane fade" id="completed">
                    <div id="completedTodos"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Todo Modal -->
<div class="modal fade" id="editToolModal" tabIndex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Todo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTodoForm">
                    <input type="hidden" id="editTodoId"/>
                    <div class="col-12 mb-3">
                        <label for="editTodoTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="editTodoTitle" required>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="editTodoDescription" class="form-label">Description *</label>
                        <input type="text" class="form-control" id="editTodoDescription" required>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="editTodoDueDate" class="form-label">Due Date *</label>
                        <input type="datetime-local" class="form-control" id="editTodoDueDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <input type="button" value="Cancel" class="btn btn-secondary" data-bs-dismiss="modal">
                <input type="button" value="Save Changes" class="btn btn-primary-custom" onclick="updateTodo()">
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastMessage" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

<script>
    const baseUrl = 'http://localhost:3000/api/v1';
    const token = localStorage.getItem('token');

    if (!token) {
        window.location.href = 'login.html';
    }

    document.getElementById('btnLogout').addEventListener('click', function () {
        localStorage.removeItem('token');
        window.location.href = 'index.html';
    })

    /*initialize-app*/
    $(document).ready(function () {
        loadAllTodos();

        // bind events
        $('#todoForm').on('submit', handleAddToDo);
        $('#editTodoForm').on('submit', function (e) {
            e.preventDefault()
        });

        // tab click event
        $('#pending-tab').on('click', function (e) {
            loadAllPendingTodos()
        });
        $('#completed-tab').on('click', function (e) {
            loadAllCompletedTodos()
        });
        $('#all-tab').on('click', function (e) {
            loadAllTodos()
        });
    })

    // Ajax helper function
    function makeAjaxCall(url, method, data = null) {
        const config = {
            url: baseUrl + url,
            method: method,
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            beforeSend: function () {
                showLoading(true);
            },
            complete: function () {
                showLoading(false);
            }
        };
        if (data) {
            config.data = JSON.stringify(data);
        }
        return $.ajax(config);
    }

    const updateTodo = function () {
        const todoId = $('#editTodoId').val();
        const todoData = {
            title: $('#editTodoTitle').val(),
            description: $('#editTodoDescription').val(),
            dueDate: $('#editTodoDueDate').val() || null
        };

        makeAjaxCall(`/todos/update-content/${todoId}`, 'PUT', todoData)
            .done(function (response) {
                showToast('Todo updated successfully!', 'success');
                $('#editToolModal').modal('hide');
                refreshCurrentTab();
            })
            .fail(function (xhr) {
                showToast('Error updating todo', 'error');
            });
    }

    const loadAllTodos = function () {
        makeAjaxCall('/todos/all', 'GET')
            .done(function (response) {
                const todoList = response.todos || [];
                displayTodos(todoList, '#allTodos');
            })
            .fail(function (xhr) {
                showToast('Error fetching todos', 'error');
            });
    }

    const loadAllPendingTodos = function () {
        makeAjaxCall('/todos/pending', 'GET')
            .done(function (response) {
                const todoList = response.todos || [];
                displayTodos(todoList, '#pendingTodos');
            })
            .fail(function (xhr) {
                showToast('Error fetching pending todos', 'error');
            });
    }

    const loadAllCompletedTodos = function () {
        makeAjaxCall('/todos/completed', 'GET')
            .done(function (response) {
                const todoList = response.todos || [];
                displayTodos(todoList, '#completedTodos');
            })
            .fail(function (xhr) {
                showToast('Error fetching completed todos', 'error');
            });
    }

    const deleteTodo = function (todoId) {
        if (confirm('Are you sure you want to delete this todo?')) {
            makeAjaxCall(`/todos/delete-by-id/${todoId}`, 'DELETE')
                .done(function (response) {
                    showToast('Todo deleted successfully!', 'success');
                    refreshCurrentTab();
                })
                .fail(function (xhr) {
                    showToast('Error deleting todo', 'error');
                });
        }
    }

    const toggleTodoStatus = function (todoId) {
        makeAjaxCall(`/todos/update-status/${todoId}`, 'PUT')
            .done(function (response) {
                showToast('Todo status updated!', 'success');
                refreshCurrentTab();
            })
            .fail(function (xhr) {
                showToast('Error updating todo status', 'error');
            });
    }

    const editTodo = function (todoId) {
        makeAjaxCall(`/todos/find-by-id/${todoId}`, 'GET')
            .done(function (response) {
                const todo = response.todo;
                if (todo) {
                    $('#editTodoId').val(todo.id);
                    $('#editTodoTitle').val(todo.title);
                    $('#editTodoDescription').val(todo.description);

                    // Format date for datetime-local input
                    if (todo.dueDate) {
                        const date = new Date(todo.dueDate);
                        const formattedDate = date.toISOString().slice(0, 16);
                        $('#editTodoDueDate').val(formattedDate);
                    }

                    $('#editToolModal').modal('show');
                }
            })
            .fail(function (xhr) {
                showToast('Error fetching todo details', 'error');
            });
    }

    const handleAddToDo = function (e) {
        e.preventDefault();
        const todoData = {
            title: $('#todoTitle').val(),
            description: $('#todoDescription').val(),
            dueDate: $('#todoDueDate').val() || null
        };

        makeAjaxCall('/todos/create', 'POST', todoData)
            .done(function (response) {
                showToast('Todo created successfully!', 'success');
                $('#todoForm')[0].reset();
                loadAllTodos();
            })
            .fail(function (xhr) {
                showToast('Error creating todo', 'error');
            });
    }

    function displayTodos(todos, container) {
        const $container = $(container);
        $container.empty();

        if (!todos || todos.length === 0) {
            $container.html(`
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-tasks fa-3x text-muted"></i>
                    </div>
                    <h5 class="text-muted">No Todos Found!</h5>
                    <p class="text-muted">Start by adding a new todo above.</p>
                </div>
            `);
            return;
        }

        todos.forEach(todo => {
            const dueDate = new Date(todo.dueDate);
            const now = new Date();
            const isOverdue = dueDate < now && todo.status === 'pending';
            const isDueSoon = (dueDate - now) < (24 * 60 * 60 * 1000) && dueDate > now && todo.status === 'pending';

            let cardClasses = 'card todo-card shadow-sm';
            if (todo.status === 'completed') {
                cardClasses += ' completed-todo';
            }
            if (isOverdue) {
                cardClasses += ' overdue';
            } else if (isDueSoon) {
                cardClasses += ' due-soon';
            }

            const formattedDueDate = dueDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const statusBadge = todo.status === 'completed'
                ? '<span class="badge bg-success todo-status">Completed</span>'
                : '<span class="badge bg-warning todo-status">Pending</span>';

            const todoCard = `
                <div class="${cardClasses}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title todo-title mb-1">${todo.title}</h6>
                            ${statusBadge}
                        </div>
                        <p class="card-text text-muted mb-2">${todo.description}</p>
                        <div class="todo-due-date mb-3">
                            <i class="far fa-calendar-alt me-1"></i>
                            Due: ${formattedDueDate}
                            ${isOverdue ? '<span class="badge bg-danger ms-2">Overdue</span>' : ''}
                            ${isDueSoon ? '<span class="badge bg-warning ms-2">Due Soon</span>' : ''}
                        </div>
                        <div class="d-flex justify-content-end btn-group-actions">
                            <button class="btn btn-outline-primary btn-sm-custom" onclick="editTodo(${todo.id})">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                            <button class="btn btn-outline-${todo.status === 'completed' ? 'warning' : 'success'} btn-sm-custom" onclick="toggleTodoStatus(${todo.id})">
                                <i class="fas fa-${todo.status === 'completed' ? 'undo' : 'check'} me-1"></i>
                                ${todo.status === 'completed' ? 'Reopen' : 'Complete'}
                            </button>
                            <button class="btn btn-outline-danger btn-sm-custom" onclick="deleteTodo(${todo.id})">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;

            $container.append(todoCard);
        });
    }

    function showLoading(status) {
        if (status) {
            $('#loadingSpinner').show();
        } else {
            $('#loadingSpinner').hide();
        }
    }

    function showToast(message, type = 'info') {
        $('#toastBody').text(message);
        const toast = new bootstrap.Toast(document.getElementById('toastMessage'));
        toast.show();
    }

    function refreshCurrentTab() {
        const activeTab = $('.nav-link.active').attr('id');
        switch (activeTab) {
            case 'pending-tab': loadAllPendingTodos(); break;
            case 'completed-tab': loadAllCompletedTodos(); break;
            default: loadAllTodos(); break;
        }
    }
</script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>